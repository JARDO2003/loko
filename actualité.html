<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Express Exchange - R√©seau Social √âtudiant (Optimis√©)</title>
  <style>
    body { font-family: 'Segoe UI',sans-serif; background: #f0f2f5; color: #222; margin:0; }
    .video-background { position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:-2; overflow:hidden;}
    .video-background video { width:100vw; height:100vh; object-fit:cover; opacity:0.7; }
    .video-overlay { position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:-1;
      background:linear-gradient(135deg,rgba(102,126,234,0.6) 0%,rgba(118,75,162,0.6) 100%);}
    .particles { position:fixed; top:0; left:0; width:100vw; height:100vh; pointer-events:none; z-index:0;}
    .particle { position:absolute; width:4px; height:4px; background:rgba(255,255,255,0.6); border-radius:50%; animation:float 6s infinite ease-in-out;}
    @keyframes float { 0%,100% {transform:translateY(0) rotate(0); opacity:0;} 50%{transform:translateY(-100px) rotate(180deg); opacity:1;} }
    .registration-overlay { position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:1000; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.8);}
    .registration-form { background:rgba(255,255,255,0.97); border-radius:15px; padding:40px; box-shadow:0 8px 40px #0003; min-width:320px; max-width:95vw;}
    .registration-form h2 { color:#764ba2; margin-bottom:10px; }
    .form-group { margin-bottom:18px; }
    .form-group label { font-weight:600; display:block; margin-bottom:5px;}
    .form-group input { width:100%; padding:10px; border-radius:7px; border:2px solid #ddd; font-size:15px;}
    .form-group input:focus { outline:none; border-color:#667eea;}
    .submit-btn { width:100%; padding:12px; border-radius:8px; border:none; background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; font-weight:bold; font-size:16px;}
    .submit-btn:hover { filter:brightness(1.1);}
    .main-app { display:none;}
    .container { max-width:580px; margin:0 auto; background:none; padding:18px;}
    .header { text-align:center; color:#fff; margin-bottom:18px; text-shadow:0 2px 10px #0003;}
    .header h1 { font-size:2.2em; margin-bottom:8px;}
    .user-info { background:rgba(255,255,255,0.13); padding:7px 18px; border-radius:20px; color:#fff; margin-bottom:20px; display:inline-block;}
    .status-indicator { margin-left:10px; border-radius:12px; padding:2px 12px; font-size:13px;}
    .status-connected { background:rgba(34,197,94,0.15); color:#22c55e;}
    .status-disconnected { background:rgba(239,68,68,0.16); color:#ef4444;}
    .post-form { background:rgba(255,255,255,0.99); border-radius:13px; padding:18px; margin-bottom:18px; box-shadow:0 3px 14px #0001;}
    .post-textarea { width:100%; min-height:70px; padding:11px; border:2px solid #eee; border-radius:8px; font-size:15px; background:#fcfcfe;}
    .post-textarea:focus { outline:none; border-color:#667eea;}
    .file-input-wrapper { margin:11px 0;}
    .file-input { display:none;}
    .file-input-label { display:inline-block; padding:7px 20px; background:#f0f0f7; border-radius:20px; cursor:pointer; }
    .file-input-label:hover { background:#e5e5ef; }
    .post-actions { display:flex; justify-content:space-between; align-items:center; margin-top:10px;}
    .post-btn { background:linear-gradient(135deg, #667eea, #764ba2); color:#fff; border:none; padding:9px 20px; border-radius:18px; font-size:15px; font-weight:500;}
    .post-btn:disabled { opacity:0.5; cursor:not-allowed;}
    .loading-indicator { display:none; color:#667eea; font-size:14px; margin-left:10px;}
    .feed { display:flex; flex-direction:column; gap:16px;}
    .publication { background:#fff; border-radius:13px; padding:17px; box-shadow:0 2px 12px #0001;}
    .pub-header { display:flex; align-items:center; margin-bottom:10px;}
    .pub-avatar { width:36px; height:36px; border-radius:50%; background:linear-gradient(135deg,#667eea,#764ba2); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600; font-size:16px; margin-right:9px;}
    .pub-info { flex:1;}
    .pub-username { font-weight:bold; color:#333;}
    .pub-time { color:#666; font-size:13px;}
    .pub-text { margin-bottom:11px; white-space:pre-wrap; }
    .image-link { cursor:pointer; display:inline-block; max-width:100%; margin-bottom:12px;}
    .image-link img { max-width:100%; max-height:270px; border-radius:7px; box-shadow:0 1px 6px #0002; transition:transform 0.18s;}
    .image-link img:hover { transform:scale(1.04);}
    .modal-image-view { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.90); z-index:4000; justify-content:center; align-items:center;}
    .modal-image-view img { max-width:98vw; max-height:96vh; border-radius:12px; box-shadow:0 2px 32px #0008;}
    .close-modal-image { position:absolute; top:24px; right:40px; color:#fff; font-size:40px; cursor:pointer; z-index:4050;}
    .pub-actions { display:flex; gap:16px; margin-bottom:11px; padding:7px 0; border-top:1px solid #eee;}
    .action-btn { background:none; border:none; color:#666; cursor:pointer; font-size:15px; display:flex; align-items:center; gap:6px;}
    .action-btn:hover { color:#667eea;}
    .action-btn.liked { color:#e74c3c;}
    .comments-section { border-top:1px solid #eee; padding-top:10px;}
    .comment { background:#f7f7fb; padding:8px 14px; border-radius:8px; margin-bottom:7px;}
    .comment-header { display:flex; align-items:center; margin-bottom:4px;}
    .comment-avatar { width:26px; height:26px; border-radius:50%; background:linear-gradient(135deg, #667eea, #764ba2); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:bold; font-size:12px; margin-right:8px;}
    .comment-username { font-weight:bold; color:#333; font-size:13px;}
    .comment-time { color:#666; font-size:11px; margin-left:auto;}
    .comment-text { font-size:13px;}
    .comment-form { display:flex; gap:8px; margin-top:7px;}
    .comment-input { flex:1; padding:7px 12px; border:1px solid #ddd; border-radius:17px; font-size:13px; background:#fff;}
    .comment-input:focus { outline:none; border-color:#667eea;}
    .comment-btn { background:#667eea; color:#fff; border:none; padding:6px 13px; border-radius:16px; font-size:13px;}
    .comment-btn:hover { background:#5a67d8;}
    @media (max-width:680px) { .container{padding:4px;} .header h1{font-size:1.4em;} .registration-form{padding:18px 4px;} }
  </style>
</head>
<body>
  <div class="video-background">
    <video autoplay muted loop>
      <source src="https://videos.pexels.com/video-files/5212456/5212456-hd_1920_1080_30fps.mp4" type="video/mp4">
      Votre navigateur ne supporte pas la vid√©o HTML5.
    </video>
  </div>
  <div class="video-overlay"></div>
  <div class="particles" id="particles"></div>

  <!-- Modal image agrandie -->
  <div class="modal-image-view" id="modalImageView">
    <span class="close-modal-image" onclick="closeImageModal()">&times;</span>
    <img id="modalImageBig" src="" alt="Image publication">
  </div>

  <!-- Formulaire d'inscription -->
  <div class="registration-overlay" id="registrationOverlay">
    <div class="registration-form">
      <h2>üéì Express Exchange</h2>
      <p>Rejoignez le r√©seau social √©tudiant</p>
      <form id="registrationForm">
        <div class="form-group">
          <label for="nom">Nom *</label>
          <input type="text" id="nom" name="nom" required>
        </div>
        <div class="form-group">
          <label for="prenom">Pr√©nom *</label>
          <input type="text" id="prenom" name="prenom" required>
        </div>
        <div class="form-group">
          <label for="contact">Contact (Email ou T√©l√©phone) *</label>
          <input type="text" id="contact" name="contact" required>
        </div>
        <button type="submit" class="submit-btn">Rejoindre Express Exchange</button>
      </form>
    </div>
  </div>

  <!-- Interface principale -->
  <div class="main-app" id="mainApp">
    <div class="container">
      <div class="header">
        <h1>üì± Express Exchange</h1>
        <div class="user-info" id="userInfo">
          <span id="welcomeMessage"></span>
          <span class="status-indicator" id="statusIndicator">üîÑ Connexion...</span>
        </div>
      </div>
      
      <div class="post-form">
        <textarea class="post-textarea" id="postText" placeholder="Que voulez-vous partager ?"></textarea>
        <div class="file-input-wrapper">
          <input type="file" id="fileInput" class="file-input" accept="image/*">
          <label for="fileInput" class="file-input-label">
            üì∑ Ajouter une photo
          </label>
          <span id="fileName"></span>
          <div class="loading-indicator" id="loadingIndicator">‚è≥ Traitement de l'image...</div>
        </div>
        <div class="post-actions">
          <div id="mediaPreview"></div>
          <button class="post-btn" id="publishBtn">Publier</button>
        </div>
      </div>
      
      <div class="feed" id="feed"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <script>
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCPGgtXoDUycykLaTSee0S0yY0tkeJpqKI",
      authDomain: "data-com-a94a8.firebaseapp.com",
      databaseURL: "https://data-com-a94a8-default-rtdb.firebaseio.com",
      projectId: "data-com-a94a8",
      storageBucket: "data-com-a94a8.appspot.com",
      messagingSenderId: "276904640935",
      appId: "1:276904640935:web:9cd805aeba6c34c767f682",
      measurementId: "G-FYQCWY5G4S"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let userData = null;
    let posts = [];
    let postsListener = null;
    let isConnected = false;
    let activeListeners = new Map(); // Pour g√©rer les listeners
    let renderTimeout = null; // Pour d√©bouncer le rendu

    // Optimisation : Traitement d'image asynchrone avec WebWorker simul√©
    function resizeImageOptimized(file, maxSizeKb = 150) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = function(event) {
          const img = new Image();
          img.onload = function() {
            // Redimensionnement plus efficace
            let { width, height } = calculateOptimalSize(img.width, img.height, 600);
            
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'medium'; // Equilibre qualit√©/performance
            ctx.drawImage(img, 0, 0, width, height);
            
            // Compression optimis√©e avec moins d'it√©rations
            let quality = 0.8;
            let dataUrl = canvas.toDataURL('image/jpeg', quality);
            let iterations = 0;
            
            while (dataUrl.length / 1024 > maxSizeKb && quality > 0.3 && iterations < 5) {
              quality -= 0.1;
              dataUrl = canvas.toDataURL('image/jpeg', quality);
              iterations++;
            }
            
            resolve(dataUrl);
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    function calculateOptimalSize(originalWidth, originalHeight, maxDimension = 600) {
      if (originalWidth <= maxDimension && originalHeight <= maxDimension) {
        return { width: originalWidth, height: originalHeight };
      }
      
      const ratio = Math.min(maxDimension / originalWidth, maxDimension / originalHeight);
      return {
        width: Math.round(originalWidth * ratio),
        height: Math.round(originalHeight * ratio)
      };
    }

    // Optimisation : D√©bouncer le rendu pour √©viter les re-rendus excessifs
    function scheduleRender() {
      if (renderTimeout) clearTimeout(renderTimeout);
      renderTimeout = setTimeout(renderPosts, 100); // Attendre 100ms avant de rendre
    }

    // Optimisation : Nettoyage des listeners inactifs
    function cleanupListeners() {
      for (const [postId, listeners] of activeListeners) {
        if (!posts.find(p => p.id === postId)) {
          listeners.forEach(listener => listener.off());
          activeListeners.delete(postId);
        }
      }
    }

    function removeUndefinedDeep(obj) {
      if (Array.isArray(obj)) {
        return obj.map(removeUndefinedDeep);
      } else if (obj && typeof obj === 'object') {
        const cleaned = {};
        for (const key in obj) {
          if (obj[key] !== undefined) {
            cleaned[key] = removeUndefinedDeep(obj[key]);
          }
        }
        return cleaned;
      }
      return obj;
    }

    function updateConnectionStatus() {
      const statusIndicator = document.getElementById('statusIndicator');
      if (statusIndicator) {
        statusIndicator.textContent = isConnected ? 'üü¢ Connect√©' : 'üî¥ Hors ligne';
        statusIndicator.className = isConnected ? 'status-indicator status-connected' : 'status-indicator status-disconnected';
      }
    }

    database.ref(".info/connected").on("value", (snap) => {
      isConnected = snap.val() === true;
      updateConnectionStatus();
    });

    function checkUserRegistration() {
      const stored = localStorage.getItem('expressExchangeUser');
      if (stored) {
        userData = JSON.parse(stored);
        showMainApp();
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      createParticles();
      checkUserRegistration();
      
      // Optimisation : R√©duire la fr√©quence de mise √† jour automatique
      setInterval(cleanupListeners, 300000); // Nettoyage toutes les 5 minutes
    });

    document.getElementById('registrationForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const nom = document.getElementById('nom').value.trim();
      const prenom = document.getElementById('prenom').value.trim();
      const contact = document.getElementById('contact').value.trim();
      
      if (nom && prenom && contact) {
        userData = {
          id: Date.now().toString(),
          nom: nom,
          prenom: prenom,
          contact: contact,
          fullName: `${prenom} ${nom}`,
          avatar: `${prenom[0]}${nom[0]}`.toUpperCase(),
          registeredAt: new Date().toISOString()
        };
        localStorage.setItem('expressExchangeUser', JSON.stringify(userData));
        if (isConnected) database.ref('users/' + userData.id).set(userData);
        showMainApp();
      }
    });

    function showMainApp() {
      document.getElementById('registrationOverlay').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      document.getElementById('welcomeMessage').textContent = `Bienvenue ${userData.fullName} üëã`;
      updateConnectionStatus();
      loadPosts();
    }

    function loadPosts() {
      if (postsListener) postsListener.off();
      postsListener = database.ref('posts').orderByChild('timestamp').limitToLast(20); // Limiter le nombre de posts
      postsListener.on('value', (snapshot) => {
        posts = [];
        snapshot.forEach((childSnapshot) => {
          const post = childSnapshot.val();
          posts.unshift(post);
        });
        scheduleRender(); // Utiliser le rendu d√©bounced
      });
    }

    // Publication optimis√©e
    document.getElementById('publishBtn').addEventListener('click', async function() {
      const text = document.getElementById('postText').value.trim();
      const fileInput = document.getElementById('fileInput');
      const publishBtn = document.getElementById('publishBtn');
      const loadingIndicator = document.getElementById('loadingIndicator');
      
      if (!text && !fileInput.files[0]) {
        alert('Veuillez ajouter du texte ou une image');
        return;
      }
      
      if (fileInput.files[0] && !fileInput.files[0].type.startsWith('image/')) {
        alert("Seules les images sont autoris√©es.");
        return;
      }

      publishBtn.disabled = true;
      publishBtn.textContent = 'Publication...';

      const postId = Date.now().toString();
      let post = {
        id: postId,
        author: userData.fullName,
        authorId: userData.id,
        avatar: userData.avatar,
        text: text,
        imageUrl: null,
        timestamp: new Date().toISOString()
      };

      try {
        if (fileInput.files[0]) {
          loadingIndicator.style.display = 'inline-block';
          const dataUrl = await resizeImageOptimized(fileInput.files[0], 150);
          post.imageUrl = dataUrl;
          loadingIndicator.style.display = 'none';
        }

        await database.ref('posts/' + post.id).set(removeUndefinedDeep(post));
        clearPostForm();
      } catch (error) {
        console.error('Erreur lors de la publication:', error);
        alert('Erreur lors de la publication.');
      } finally {
        publishBtn.disabled = false;
        publishBtn.textContent = 'Publier';
        loadingIndicator.style.display = 'none';
      }
    });

    // Optimisation : Gestion d'image avec preview imm√©diat
    document.getElementById('fileInput').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      const fileName = document.getElementById('fileName');
      const preview = document.getElementById('mediaPreview');
      const loadingIndicator = document.getElementById('loadingIndicator');
      
      if (file) {
        fileName.textContent = file.name;
        loadingIndicator.style.display = 'inline-block';
        
        try {
          const dataUrl = await resizeImageOptimized(file, 150);
          preview.innerHTML = `<img src="${dataUrl}" style="max-width: 100px; max-height: 100px; border-radius: 5px;">`;
        } catch (error) {
          console.error('Erreur traitement image:', error);
          alert('Erreur lors du traitement de l\'image');
        } finally {
          loadingIndicator.style.display = 'none';
        }
      } else {
        fileName.textContent = '';
        preview.innerHTML = '';
      }
    });

    function clearPostForm() {
      document.getElementById('postText').value = '';
      document.getElementById('fileInput').value = '';
      document.getElementById('fileName').textContent = '';
      document.getElementById('mediaPreview').innerHTML = '';
    }

    // Modal image
    window.openImageModal = function(imgUrl) {
      const modal = document.getElementById('modalImageView');
      const modalImg = document.getElementById('modalImageBig');
      modal.style.display = 'flex';
      modalImg.src = imgUrl;
    };

    window.closeImageModal = function() {
      document.getElementById('modalImageView').style.display = 'none';
    };

    // Optimisation : Listeners plus efficaces
    function setupPostListeners(postId) {
      if (activeListeners.has(postId)) return; // √âviter les doublons
      
      const listeners = [];
      
      // Listener pour les likes
      const likesRef = database.ref('likes/' + postId);
      const likesListener = likesRef.on('value', snap => {
        const likes = snap.val() || {};
        const post = posts.find(p => p.id === postId);
        if (post) {
          post.likes = removeUndefinedDeep(likes);
          updatePostElement(postId, 'likes');
        }
      });
      listeners.push({ ref: likesRef, listener: likesListener });
      
      // Listener pour les commentaires
      const commentsRef = database.ref('comments/' + postId);
      const commentsListener = commentsRef.on('value', snap => {
        const comments = snap.val() || {};
        const post = posts.find(p => p.id === postId);
        if (post) {
          post.comments = removeUndefinedDeep(comments);
          updatePostElement(postId, 'comments');
        }
      });
      listeners.push({ ref: commentsRef, listener: commentsListener });
      
      activeListeners.set(postId, listeners);
    }

    // Optimisation : Mise √† jour s√©lective des √©l√©ments
    function updatePostElement(postId, type) {
      const post = posts.find(p => p.id === postId);
      if (!post) return;
      
      if (type === 'likes') {
        const likesCount = post.likes ? Object.keys(post.likes).length : 0;
        const isLiked = post.likes && post.likes[userData.id];
        const likeBtn = document.getElementById('like-btn-' + postId);
        if (likeBtn) {
          likeBtn.innerHTML = `${isLiked ? '‚ù§Ô∏è' : 'ü§ç'} ${likesCount}`;
          likeBtn.className = `action-btn ${isLiked ? 'liked' : ''}`;
        }
      }
      
      if (type === 'comments') {
        const commentsCount = post.comments ? Object.keys(post.comments).length : 0;
        const commentBtn = document.querySelector(`button[onclick="toggleComments('${postId}')"]`);
        if (commentBtn) {
          commentBtn.innerHTML = `üí¨ ${commentsCount}`;
        }
        
        // Mise √† jour de la section commentaires si elle est visible
        const commentsSection = document.getElementById(`comments-${postId}`);
        if (commentsSection && commentsSection.style.display !== 'none') {
          renderCommentsForPost(postId);
        }
      }
    }

    function renderCommentsForPost(postId) {
      const post = posts.find(p => p.id === postId);
      const commentsSection = document.getElementById(`comments-${postId}`);
      if (!post || !commentsSection) return;
      
      let commentsHTML = '';
      if (post.comments) {
        const commentsList = Object.values(post.comments).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        commentsHTML = commentsList.map(comment => `
          <div class="comment">
            <div class="comment-header">
              <div class="comment-avatar">${comment.avatar}</div>
              <div class="comment-username">${comment.author}</div>
              <div class="comment-time">${getTimeAgo(comment.timestamp)}</div>
            </div>
            <div class="comment-text">${comment.text}</div>
          </div>
        `).join('');
      }
      
      commentsSection.innerHTML = `
        ${commentsHTML}
        <div class="comment-form">
          <input type="text" class="comment-input" placeholder="√âcrivez un commentaire..." id="comment-input-${postId}">
          <button class="comment-btn" onclick="submitComment('${postId}')">Envoyer</button>
        </div>
      `;
    }

    function renderPosts() {
      const feed = document.getElementById('feed');
      feed.innerHTML = '';
      
      posts.forEach(post => {
        setupPostListeners(post.id);
        
        const likesCount = post.likes ? Object.keys(post.likes).length : 0;
        const commentsCount = post.comments ? Object.keys(post.comments).length : 0;
        const isLiked = post.likes && post.likes[userData.id];
        const timeAgo = getTimeAgo(post.timestamp);
        
        let imageHTML = '';
        if (post.imageUrl) {
          imageHTML = `
            <div>
              <a class="image-link" onclick="openImageModal('${post.imageUrl}')">
                <img src="${post.imageUrl}" alt="Image publication" loading="lazy">
              </a>
            </div>
          `;
        }

        const postHtml = `
          <div class="publication" data-post-id="${post.id}">
            <div class="pub-header">
              <div class="pub-avatar">${post.avatar}</div>
              <div class="pub-info">
                <div class="pub-username">${post.author}</div>
                <div class="pub-time">${timeAgo}</div>
              </div>
            </div>
            <div class="pub-text">${post.text}</div>
            ${imageHTML}
            <div class="pub-actions">
              <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${post.id}')" id="like-btn-${post.id}">
                ${isLiked ? '‚ù§Ô∏è' : 'ü§ç'} ${likesCount}
              </button>
              <button class="action-btn" onclick="toggleComments('${post.id}')">
                üí¨ ${commentsCount}
              </button>
            </div>
            <div class="comments-section" id="comments-${post.id}" style="display: none;">
              <!-- Les commentaires seront charg√©s dynamiquement -->
            </div>
          </div>
        `;
        feed.innerHTML += postHtml;
      });
    }

    // Actions optimis√©es
    window.toggleLike = function(postId) {
      const btn = document.getElementById('like-btn-' + postId);
      if (btn) btn.disabled = true;
      
      const likeRef = database.ref('likes/' + postId + '/' + userData.id);
      likeRef.once('value').then(snapshot => {
        if (snapshot.exists()) {
          likeRef.remove();
        } else {
          likeRef.set(removeUndefinedDeep({
            userId: userData.id,
            username: userData.fullName,
            timestamp: new Date().toISOString()
          }));
        }
        if (btn) btn.disabled = false;
      }).catch(error => {
        console.error('Erreur toggle like:', error);
        if (btn) btn.disabled = false;
      });
    };

    window.toggleComments = function(postId) {
      const commentsSection = document.getElementById(`comments-${postId}`);
      if (commentsSection.style.display === 'none') {
        commentsSection.style.display = 'block';
        renderCommentsForPost(postId);
      } else {
        commentsSection.style.display = 'none';
      }
    };

    window.submitComment = function(postId) {
      const input = document.getElementById(`comment-input-${postId}`);
      if (!input) return;
      
      const commentText = input.value.trim();
      if (!commentText) return;
      
      const commentsRef = database.ref('comments/' + postId);
      const commentId = commentsRef.push().key;
      const comment = removeUndefinedDeep({
        id: commentId,
        author: userData.fullName,
        authorId: userData.id,
        avatar: userData.avatar,
        text: commentText,
        timestamp: new Date().toISOString()
      });
      
      commentsRef.child(commentId).set(comment).then(() => {
        input.value = '';
      }).catch(error => {
        console.error('Erreur ajout commentaire:', error);
        alert('Erreur lors de l\'ajout du commentaire');
      });
    };

    // Gestion des √©v√©nements clavier optimis√©e
    document.addEventListener('keydown', function(e) {
      if (e.target.classList.contains('comment-input') && e.key === 'Enter') {
        const postId = e.target.id.replace('comment-input-', '');
        window.submitComment(postId);
      }
    });

    // Events pour modal image
    document.getElementById('modalImageView').addEventListener('click', function(e){
      if(e.target === this){ closeImageModal(); }
    });
    
    document.addEventListener('keydown', function(e){
      if(e.key === 'Escape'){ closeImageModal(); }
    });

    function getTimeAgo(timestamp) {
      const now = new Date();
      const time = new Date(timestamp);
      const diffInSeconds = Math.floor((now - time) / 1000);
      
      if (diffInSeconds < 60) return '√Ä l\'instant';
      if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `Il y a ${minutes} minute${minutes > 1 ? 's' : ''}`;
      } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `Il y a ${hours} heure${hours > 1 ? 's' : ''}`;
      } else {
        const days = Math.floor(diffInSeconds / 86400);
        return `Il y a ${days} jour${days > 1 ? 's' : ''}`;
      }
    }

    function createParticles() {
      const particles = document.getElementById('particles');
      if (!particles) return;
      
      // R√©duire le nombre de particules sur mobile pour les performances
      const particleCount = window.innerWidth < 768 ? 10 : 20;
      
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 6 + 's';
        particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
        particles.appendChild(particle);
      }
    }

    // Optimisation : R√©duire la fr√©quence de recr√©ation des particules
    let particleTimeout;
    window.addEventListener('resize', function() {
      if (particleTimeout) clearTimeout(particleTimeout);
      particleTimeout = setTimeout(() => {
        const particles = document.getElementById('particles');
        if (particles) {
          particles.innerHTML = '';
          createParticles();
        }
      }, 300);
    });

    // Nettoyage lors de la fermeture de la page
    window.addEventListener('beforeunload', function() {
      if (postsListener) postsListener.off();
      for (const [postId, listeners] of activeListeners) {
        listeners.forEach(listenerObj => {
          listenerObj.ref.off('value', listenerObj.listener);
        });
      }
      activeListeners.clear();
    });

    // Optimisation : Intersection Observer pour lazy loading avanc√©
    if ('IntersectionObserver' in window) {
      const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            if (img.dataset.src) {
              img.src = img.dataset.src;
              img.removeAttribute('data-src');
              observer.unobserve(img);
            }
          }
        });
      });

      // Cette fonction sera appel√©e apr√®s le rendu des posts
      function observeImages() {
        document.querySelectorAll('img[data-src]').forEach(img => {
          imageObserver.observe(img);
        });
      }
    }

    // Performance monitoring (optionnel, pour debug)
    function logPerformance(label, startTime) {
      if (performance && performance.now) {
        const duration = performance.now() - startTime;
        if (duration > 100) { // Log seulement si > 100ms
          console.log(`‚ö° ${label}: ${duration.toFixed(2)}ms`);
        }
      }
    }

    // Optimisation : Cache simple pour les avatars
    const avatarCache = new Map();
    function getCachedAvatar(userId, name) {
      if (!avatarCache.has(userId)) {
        const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
        avatarCache.set(userId, initials);
      }
      return avatarCache.get(userId);
    }

    // Service Worker pour cache offline (optionnel)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        // Enregistrer un service worker ici si n√©cessaire
      });
    }
     // --- Gestion de la reconnexion automatique et feedback utilisateur ---
  let reconnectInterval = null;
  
  function tryReconnect() {
    if (!isConnected) {
      if (!reconnectInterval) {
        reconnectInterval = setInterval(() => {
          database.ref(".info/connected").once("value").then(snap => {
            if (snap.val() === true) {
              isConnected = true;
              updateConnectionStatus();
              if (reconnectInterval) {
                clearInterval(reconnectInterval);
                reconnectInterval = null;
              }
              // Reload posts to resume feed after reconnection
              loadPosts();
            }
          });
        }, 4000); // Tentative toutes les 4s
      }
    }
  }
  // D√©tection de d√©co/reco
  database.ref(".info/connected").on("value", (snap) => {
    isConnected = snap.val() === true;
    updateConnectionStatus();
    if (!isConnected) {
      tryReconnect();
    } else if (reconnectInterval) {
      clearInterval(reconnectInterval);
      reconnectInterval = null;
    }
  });

  // --- Options de d√©connexion volontaire et changement d'utilisateur ---
  function disconnectAndReset() {
    localStorage.removeItem('expressExchangeUser');
    window.location.reload();
  }

  // Ajout d'un bouton de d√©connexion √† l'UI
  function addLogoutButton() {
    const userInfo = document.getElementById('userInfo');
    if (userInfo && !document.getElementById('logoutBtn')) {
      const btn = document.createElement('button');
      btn.id = "logoutBtn";
      btn.textContent = "Se d√©connecter";
      btn.style.marginLeft = "16px";
      btn.style.padding = "3px 15px";
      btn.style.borderRadius = "10px";
      btn.style.border = "none";
      btn.style.background = "linear-gradient(135deg,#f43f5e,#8b5cf6)";
      btn.style.color = "#fff";
      btn.style.cursor = "pointer";
      btn.style.fontSize = "13px";
      btn.onclick = disconnectAndReset;
      userInfo.appendChild(btn);
    }
  }

  // Ajout du bouton lors de l'affichage principal
  function showMainAppPatched() {
    document.getElementById('registrationOverlay').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('welcomeMessage').textContent = `Bienvenue ${userData.fullName} üëã`;
    updateConnectionStatus();
    addLogoutButton();
    loadPosts();
  }
  // Remplacement de showMainApp par la version patch√©e
  showMainApp = showMainAppPatched;

  // --- Accessibilit√© : focus automatique sur la zone de texte √† l'arriv√©e ---
  function autoFocusPostInput() {
    const postInput = document.getElementById('postText');
    if (postInput) {
      postInput.focus();
    }
  }
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(autoFocusPostInput, 300);
  });

  // --- R√©actions futures (am√©lioration possible) ---
  /*
  // Pour permettre d'autres r√©actions, remplacer le bouton like par un menu.
  // Ce code n'est pas activ√© mais montre comment √©tendre.
  function showReactionsMenu(postId) {
    // Cr√©er et afficher un menu contextuel d'√©mojis, etc.
  }
  */

  // --- Notifications de nouvelle publication (exp√©rimental, optionnel) ---
  let lastPostTimestamp = null;
  function notifyNewPost() {
    if (window.Notification && Notification.permission === "granted") {
      new Notification("Nouvelle publication sur Express Exchange !");
    }
  }
  function checkForNewPosts() {
    if (posts.length) {
      const latest = posts[0].timestamp;
      if (lastPostTimestamp && latest !== lastPostTimestamp) {
        notifyNewPost();
      }
      lastPostTimestamp = latest;
    }
  }
  setInterval(checkForNewPosts, 20000); // V√©rifie toutes les 20s

  // Demande l'autorisation de notification au chargement
  if (window.Notification && Notification.permission !== "granted") {
    Notification.requestPermission();
  }

  // --- Patch pour r√©afficher les images lors du lazy loading (IntersectionObserver) ---
  if ('IntersectionObserver' in window) {
    // Observe images apr√®s chaque rendu
    const oldRenderPosts = renderPosts;
    renderPosts = function() {
      oldRenderPosts();
      setTimeout(() => {
        if (typeof observeImages === "function") observeImages();
      }, 50);
    };
  }

  // --- Optionnel : Annuler une image s√©lectionn√©e avant publication ---
  function addCancelImageBtn() {
    const mediaPreview = document.getElementById('mediaPreview');
    if (mediaPreview && !document.getElementById('cancelImageBtn') && mediaPreview.innerHTML.trim() !== '') {
      const btn = document.createElement('button');
      btn.id = "cancelImageBtn";
      btn.textContent = "Annuler l'image";
      btn.style.marginLeft = "10px";
      btn.style.borderRadius = "8px";
      btn.style.border = "none";
      btn.style.background = "#eee";
      btn.style.cursor = "pointer";
      btn.onclick = function() {
        document.getElementById('fileInput').value = '';
        document.getElementById('fileName').textContent = '';
        document.getElementById('mediaPreview').innerHTML = '';
      };
      mediaPreview.appendChild(btn);
    }
  }
  // Ajoute le bouton d'annulation lors du changement de fichier
  document.getElementById('fileInput').addEventListener('change', addCancelImageBtn);

  // --- (Fin de la suite du code optimis√©) ---
</script>
