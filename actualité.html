<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Express Exchange - R√©seau Social √âtudiant</title>
  <style>
    /* Styles de base */
    body { 
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 0;
      color: #333;
      background: #f0f2f5;
    }
    
    /* Arri√®re-plan vid√©o */
    .video-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -2;
      overflow: hidden;
    }
    .video-background video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.7;
    }
    .video-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, rgba(102,126,234,0.6) 0%, rgba(118,75,162,0.6) 100%);
      z-index: -1;
    }
    
    /* Conteneur principal */
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 15px;
    }
    
    /* En-t√™te */
    .header {
      text-align: center;
      color: white;
      margin-bottom: 20px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    /* Formulaire de publication */
    .post-form {
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    .post-textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 2px solid #eee;
      border-radius: 10px;
      font-size: 16px;
      resize: none;
      margin-bottom: 10px;
    }
    .post-textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    .file-input-wrapper {
      margin-bottom: 10px;
    }
    .file-input-label {
      display: inline-block;
      padding: 8px 15px;
      background: #f0f0f7;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
    }
    .post-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .post-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 10px 25px;
      border-radius: 20px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .post-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    .post-btn:hover:not(:disabled) {
      transform: translateY(-2px);
    }
    
    /* Barre de progression */
    .upload-progress {
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      margin-top: 10px;
      overflow: hidden;
      display: none;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s;
    }
    
    /* Feed de publications */
    .feed {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    /* Publication individuelle */
    .publication {
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      backdrop-filter: blur(10px);
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .pub-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    .pub-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 10px;
      flex-shrink: 0;
    }
    .pub-user {
      flex-grow: 1;
    }
    .pub-username {
      font-weight: bold;
    }
    .pub-time {
      font-size: 12px;
      color: #666;
    }
    .pub-text {
      margin-bottom: 10px;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    .pub-image-container {
      margin-top: 10px;
      border-radius: 8px;
      overflow: hidden;
    }
    .pub-image {
      max-width: 100%;
      max-height: 300px;
      display: block;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .pub-image:hover {
      transform: scale(1.02);
    }
    .image-loading {
      background: #f5f5f5;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
    }
    
    /* Actions de publication */
    .pub-actions {
      display: flex;
      gap: 20px;
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }
    .action-btn {
      background: none;
      border: none;
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      font-size: 14px;
      color: #555;
    }
    .action-btn.liked {
      color: #e74c3c;
    }
    .action-btn:hover {
      color: #667eea;
    }
    
    /* Section commentaires */
    .comments-section {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
      display: none;
    }
    .comments-list {
      margin-bottom: 10px;
      max-height: 300px;
      overflow-y: auto;
    }
    .comment {
      background: #f7f7fb;
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .comment-header {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .comment-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
    }
    .comment-username {
      font-weight: bold;
      font-size: 13px;
    }
    .comment-time {
      font-size: 11px;
      color: #666;
      margin-left: auto;
    }
    .comment-text {
      font-size: 14px;
      line-height: 1.3;
    }
    .comment-form {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .comment-input {
      flex-grow: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 20px;
      font-size: 14px;
    }
    .comment-input:focus {
      outline: none;
      border-color: #667eea;
    }
    .comment-btn {
      background: #667eea;
      color: white;
      border: none;
      border-radius: 20px;
      padding: 8px 15px;
      font-size: 14px;
      cursor: pointer;
    }
    
    /* Modal image */
    .image-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-image {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 8px;
    }
    .close-modal {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 40px;
      cursor: pointer;
    }
    
    /* Responsive */
    @media (max-width: 600px) {
      .container {
        padding: 10px;
      }
      .post-form {
        padding: 12px;
      }
      .pub-actions {
        gap: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="video-background">
    <video autoplay muted loop>
      <source src="https://videos.pexels.com/video-files/5212456/5212456-hd_1920_1080_30fps.mp4" type="video/mp4">
    </video>
  </div>
  <div class="video-overlay"></div>

  <div class="container">
    <div class="header">
      <h1>üì± Express Exchange</h1>
      <div id="user-info" style="display: inline-block; background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; color: white;">
        <span id="username-display"></span>
        <span id="connection-status" style="margin-left: 10px; font-size: 12px;">üü¢ Connect√©</span>
      </div>
    </div>

    <div class="post-form">
      <textarea class="post-textarea" id="post-text" placeholder="Quoi de neuf aujourd'hui ?"></textarea>
      <div class="file-input-wrapper">
        <input type="file" id="file-input" accept="image/*" style="display: none;">
        <label for="file-input" class="file-input-label" id="file-label">üì∑ Ajouter une photo</label>
        <span id="file-name" style="font-size: 12px; margin-left: 10px; color: #666;"></span>
      </div>
      <div id="image-preview" style="margin-bottom: 10px;"></div>
      <div class="upload-progress" id="upload-progress">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
      <div class="post-actions">
        <div></div>
        <button class="post-btn" id="publish-btn">Publier</button>
      </div>
    </div>

    <div class="feed" id="feed"></div>
  </div>

  <!-- Modal pour les images -->
  <div class="image-modal" id="image-modal">
    <span class="close-modal" onclick="closeImageModal()">&times;</span>
    <img class="modal-image" id="modal-image" src="">
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/compressorjs@1.1.1/dist/compressor.min.js"></script>

  <script>
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCPGgtXoDUycykLaTSee0S0yY0tkeJpqKI",
      databaseURL: "https://data-com-a94a8-default-rtdb.firebaseio.com",
      projectId: "data-com-a94a8",
      storageBucket: "data-com-a94a8.appspot.com",
      messagingSenderId: "276904640935",
      appId: "1:276904640935:web:9cd805aeba6c34c767f682"
    };

    // Initialisation Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // √âl√©ments DOM
    const postText = document.getElementById('post-text');
    const fileInput = document.getElementById('file-input');
    const fileLabel = document.getElementById('file-label');
    const fileName = document.getElementById('file-name');
    const imagePreview = document.getElementById('image-preview');
    const publishBtn = document.getElementById('publish-btn');
    const uploadProgress = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    const feed = document.getElementById('feed');
    const imageModal = document.getElementById('image-modal');
    const modalImage = document.getElementById('modal-image');
    const usernameDisplay = document.getElementById('username-display');
    const connectionStatus = document.getElementById('connection-status');

    // Donn√©es utilisateur
    let userData = {
      id: '',
      fullName: '',
      avatar: ''
    };

    // V√©rifier l'inscription au chargement
    document.addEventListener('DOMContentLoaded', () => {
      checkUserRegistration();
      setupConnectionMonitoring();
      setupEventListeners();
      loadPosts();
    });

    function checkUserRegistration() {
      const savedUser = localStorage.getItem('expressExchangeUser');
      if (savedUser) {
        userData = JSON.parse(savedUser);
        usernameDisplay.textContent = userData.fullName;
        showAppInterface();
      } else {
        showRegistrationModal();
      }
    }

    function showRegistrationModal() {
      // Code du modal d'inscription (simplifi√© pour l'exemple)
      const name = prompt("Entrez votre pr√©nom et nom:");
      if (name) {
        userData = {
          id: Date.now().toString(),
          fullName: name,
          avatar: name.split(' ').map(n => n[0]).join('').toUpperCase()
        };
        localStorage.setItem('expressExchangeUser', JSON.stringify(userData));
        usernameDisplay.textContent = userData.fullName;
        showAppInterface();
        
        // Enregistrer l'utilisateur dans Firebase
        if (navigator.onLine) {
          database.ref('users/' + userData.id).set(userData);
        }
      }
    }

    function showAppInterface() {
      // L'interface est d√©j√† visible dans cette version
    }

    function setupConnectionMonitoring() {
      database.ref('.info/connected').on('value', (snap) => {
        const isConnected = snap.val() === true;
        connectionStatus.textContent = isConnected ? 'üü¢ Connect√©' : 'üî¥ Hors ligne';
        connectionStatus.style.color = isConnected ? '#4CAF50' : '#f44336';
      });
    }

    function setupEventListeners() {
      // S√©lection de fichier
      fileInput.addEventListener('change', handleFileSelect);
      
      // Publication
      publishBtn.addEventListener('click', publishPost);
      
      // Soumission avec Entr√©e dans les commentaires
      document.addEventListener('keypress', (e) => {
        if (e.target.classList.contains('comment-input') && e.key === 'Enter') {
          const postId = e.target.id.split('-')[2];
          submitComment(postId);
        }
      });
    }

    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (!file) return;

      fileName.textContent = file.name;
      
      // Aper√ßu imm√©diat
      const reader = new FileReader();
      reader.onload = (event) => {
        imagePreview.innerHTML = `
          <img src="${event.target.result}" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
        `;
      };
      reader.readAsDataURL(file);
    }

    async function publishPost() {
      const text = postText.value.trim();
      const file = fileInput.files[0];
      
      if (!text && !file) {
        alert('Veuillez √©crire un message ou ajouter une photo');
        return;
      }

      // D√©sactiver le bouton pendant le traitement
      publishBtn.disabled = true;
      publishBtn.textContent = 'Publication...';
      uploadProgress.style.display = 'block';

      try {
        const postId = Date.now().toString();
        const postData = {
          id: postId,
          author: userData.fullName,
          authorId: userData.id,
          avatar: userData.avatar,
          text: text,
          timestamp: new Date().toISOString(),
          imageUrl: file ? 'processing' : null
        };

        // Enregistrement imm√©diat dans Firebase
        await database.ref('posts/' + postId).set(postData);
        
        // Affichage optimiste dans le feed
        displayPost(postData);
        
        // Traitement de l'image en arri√®re-plan si n√©cessaire
        if (file) {
          processAndUploadImage(file, postId);
        }
        
        resetPostForm();
      } catch (error) {
        console.error("Erreur de publication:", error);
        alert("Une erreur est survenue lors de la publication");
        resetPostForm();
      }
    }

    async function processAndUploadImage(file, postId) {
      try {
        // Compression de l'image
        updateProgress(10, "Compression de l'image...");
        
        const compressedFile = await new Promise((resolve) => {
          new Compressor(file, {
            quality: 0.7,
            maxWidth: 800,
            maxHeight: 800,
            convertSize: 200000, // 200KB
            success: resolve,
            error: (err) => {
              console.error("Erreur de compression:", err);
              resolve(file); // Fallback sur le fichier original
            }
          });
        });

        // Simulation de l'upload avec progression
        updateProgress(30, "Envoi de l'image...");
        await simulateUploadProgress();
        
        // Conversion en base64
        updateProgress(80, "Finalisation...");
        const imageUrl = await fileToBase64(compressedFile);
        
        // Mise √† jour du post avec l'URL finale
        await database.ref('posts/' + postId).update({
          imageUrl: imageUrl
        });
        
        // Mise √† jour de l'affichage local
        updatePostImage(postId, imageUrl);
        
      } catch (error) {
        console.error("Erreur traitement image:", error);
        await database.ref('posts/' + postId).update({
          imageUrl: 'error'
        });
      } finally {
        updateProgress(100, "Publication termin√©e");
        setTimeout(() => {
          uploadProgress.style.display = 'none';
          progressBar.style.width = '0%';
        }, 1000);
      }
    }

    function updateProgress(percent, message) {
      progressBar.style.width = `${percent}%`;
      publishBtn.textContent = message;
    }

    function simulateUploadProgress() {
      return new Promise((resolve) => {
        let progress = 30;
        const interval = setInterval(() => {
          progress += 5 + Math.random() * 10;
          if (progress >= 80) {
            clearInterval(interval);
            resolve();
          } else {
            progressBar.style.width = `${progress}%`;
          }
        }, 200);
      });
    }

    function fileToBase64(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.readAsDataURL(file);
      });
    }

    function resetPostForm() {
      postText.value = '';
      fileInput.value = '';
      fileName.textContent = '';
      imagePreview.innerHTML = '';
      publishBtn.disabled = false;
      publishBtn.textContent = 'Publier';
    }

    function loadPosts() {
      database.ref('posts').orderByChild('timestamp').on('value', (snapshot) => {
        feed.innerHTML = '';
        snapshot.forEach((child) => {
          const post = child.val();
          displayPost(post);
        });
      });
    }

    function displayPost(post) {
      const postElement = document.createElement('div');
      postElement.className = 'publication';
      postElement.id = `post-${post.id}`;
      
      // Calcul des m√©triques
      const likesCount = post.likes ? Object.keys(post.likes).length : 0;
      const commentsCount = post.comments ? Object.keys(post.comments).length : 0;
      const isLiked = post.likes && post.likes[userData.id];
      
      postElement.innerHTML = `
        <div class="pub-header">
          <div class="pub-avatar">${post.avatar || post.author.charAt(0)}</div>
          <div class="pub-user">
            <div class="pub-username">${post.author}</div>
            <div class="pub-time">${formatTime(post.timestamp)}</div>
          </div>
        </div>
        <div class="pub-text">${post.text || ''}</div>
        ${post.imageUrl === 'processing' ? `
          <div class="image-loading">
            <div>üì∑ Image en cours de traitement...</div>
          </div>
        ` : post.imageUrl && post.imageUrl !== 'processing' ? `
          <div class="pub-image-container">
            <img src="${post.imageUrl}" class="pub-image" onclick="openImageModal('${post.imageUrl}')">
          </div>
        ` : ''}
        
        <div class="pub-actions">
          <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${post.id}')">
            ${isLiked ? '‚ù§Ô∏è' : 'ü§ç'} ${likesCount}
          </button>
          <button class="action-btn" onclick="toggleComments('${post.id}')">
            üí¨ ${commentsCount}
          </button>
        </div>
        
        <div class="comments-section" id="comments-${post.id}">
          <div class="comments-list" id="comments-list-${post.id}">
            ${post.comments ? renderComments(post.comments) : ''}
          </div>
          <div class="comment-form">
            <input type="text" class="comment-input" id="comment-input-${post.id}" placeholder="Ajouter un commentaire...">
            <button class="comment-btn" onclick="submitComment('${post.id}')">Envoyer</button>
          </div>
        </div>
      `;
      
      feed.prepend(postElement);
      setupPostListeners(post.id);
    }

    function updatePostImage(postId, imageUrl) {
      const postElement = document.getElementById(`post-${postId}`);
      if (postElement) {
        const imageContainer = postElement.querySelector('.image-loading');
        if (imageContainer) {
          imageContainer.outerHTML = `
            <div class="pub-image-container">
              <img src="${imageUrl}" class="pub-image" onclick="openImageModal('${imageUrl}')">
            </div>
          `;
        }
      }
    }

    function setupPostListeners(postId) {
      // Likes
      database.ref(`likes/${postId}`).on('value', (snapshot) => {
        const likes = snapshot.val() || {};
        const likeBtn = document.querySelector(`#post-${postId} .pub-actions button:first-child`);
        if (likeBtn) {
          const isLiked = likes[userData.id];
          const likesCount = Object.keys(likes).length;
          likeBtn.innerHTML = `${isLiked ? '‚ù§Ô∏è' : 'ü§ç'} ${likesCount}`;
          likeBtn.classList.toggle('liked', isLiked);
        }
      });
      
      // Commentaires
      database.ref(`comments/${postId}`).on('value', (snapshot) => {
        const comments = snapshot.val() || {};
        const commentsList = document.getElementById(`comments-list-${postId}`);
        if (commentsList) {
          commentsList.innerHTML = renderComments(comments);
        }
      });
    }

    function renderComments(comments) {
      return Object.values(comments)
        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
        .map(comment => `
          <div class="comment">
            <div class="comment-header">
              <div class="comment-avatar">${comment.author.charAt(0)}</div>
              <div class="comment-username">${comment.author}</div>
              <div class="comment-time">${formatTime(comment.timestamp)}</div>
            </div>
            <div class="comment-text">${comment.text}</div>
          </div>
        `).join('');
    }

    function formatTime(timestamp) {
      const now = new Date();
      const date = new Date(timestamp);
      const diff = Math.floor((now - date) / 1000);
      
      if (diff < 60) return '√Ä l\'instant';
      if (diff < 3600) return `Il y a ${Math.floor(diff/60)} min`;
      if (diff < 86400) return `Il y a ${Math.floor(diff/3600)} h`;
      return `Le ${date.toLocaleDateString()}`;
    }

    // Fonctions globales
    window.toggleLike = function(postId) {
      const likeRef = database.ref(`likes/${postId}/${userData.id}`);
      likeRef.once('value').then(snap => {
        if (snap.exists()) {
          likeRef.remove();
        } else {
          likeRef.set({
            userId: userData.id,
            timestamp: new Date().toISOString()
          });
        }
      });
    };

    window.toggleComments = function(postId) {
      const commentsSection = document.getElementById(`comments-${postId}`);
      if (commentsSection) {
        commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
      }
    };

    window.submitComment = function(postId) {
      const input = document.getElementById(`comment-input-${postId}`);
      const text = input.value.trim();
      if (!text) return;
      
      const commentId = database.ref(`comments/${postId}`).push().key;
      const comment = {
        id: commentId,
        author: userData.fullName,
        authorId: userData.id,
        text: text,
        timestamp: new Date().toISOString()
      };
      
      database.ref(`comments/${postId}/${commentId}`).set(comment);
      input.value = '';
    };

    window.openImageModal = function(imageUrl) {
      modalImage.src = imageUrl;
      imageModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    };

    window.closeImageModal = function() {
      imageModal.style.display = 'none';
      document.body.style.overflow = '';
    };

    // Fermer le modal en cliquant √† l'ext√©rieur
    imageModal.addEventListener('click', (e) => {
      if (e.target === imageModal) {
        closeImageModal();
      }
    });
  </script>
</body>
</html>
