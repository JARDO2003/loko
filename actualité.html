<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Express Exchange - R√©seau Social √âtudiant</title>
  <style>
    body { font-family: 'Segoe UI',sans-serif; background: #f0f2f5; color: #222; margin:0; }
    .video-background { position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:-2; overflow:hidden;}
    .video-background video { width:100vw; height:100vh; object-fit:cover; opacity:0.7; }
    .video-overlay { position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:-1;
      background:linear-gradient(135deg,rgba(102,126,234,0.6) 0%,rgba(118,75,162,0.6) 100%);}
    .particles { position:fixed; top:0; left:0; width:100vw; height:100vh; pointer-events:none; z-index:0;}
    .particle { position:absolute; width:4px; height:4px; background:rgba(255,255,255,0.6); border-radius:50%; animation:float 6s infinite ease-in-out;}
    @keyframes float { 0%,100% {transform:translateY(0) rotate(0); opacity:0;} 50%{transform:translateY(-100px) rotate(180deg); opacity:1;} }
    .registration-overlay { position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:1000; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.8);}
    .registration-form { background:rgba(255,255,255,0.97); border-radius:15px; padding:40px; box-shadow:0 8px 40px #0003; min-width:320px; max-width:95vw;}
    .registration-form h2 { color:#764ba2; margin-bottom:10px; }
    .form-group { margin-bottom:18px; }
    .form-group label { font-weight:600; display:block; margin-bottom:5px;}
    .form-group input { width:100%; padding:10px; border-radius:7px; border:2px solid #ddd; font-size:15px;}
    .form-group input:focus { outline:none; border-color:#667eea;}
    .submit-btn { width:100%; padding:12px; border-radius:8px; border:none; background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; font-weight:bold; font-size:16px;}
    .submit-btn:hover { filter:brightness(1.1);}
    .main-app { display:none;}
    .container { max-width:580px; margin:0 auto; background:none; padding:18px;}
    .header { text-align:center; color:#fff; margin-bottom:18px; text-shadow:0 2px 10px #0003;}
    .header h1 { font-size:2.2em; margin-bottom:8px;}
    .user-info { background:rgba(255,255,255,0.13); padding:7px 18px; border-radius:20px; color:#fff; margin-bottom:20px; display:inline-block;}
    .status-indicator { margin-left:10px; border-radius:12px; padding:2px 12px; font-size:13px;}
    .status-connected { background:rgba(34,197,94,0.15); color:#22c55e;}
    .status-disconnected { background:rgba(239,68,68,0.16); color:#ef4444;}
    .post-form { background:rgba(255,255,255,0.99); border-radius:13px; padding:18px; margin-bottom:18px; box-shadow:0 3px 14px #0001;}
    .post-textarea { width:100%; min-height:70px; padding:11px; border:2px solid #eee; border-radius:8px; font-size:15px; background:#fcfcfe;}
    .post-textarea:focus { outline:none; border-color:#667eea;}
    .file-input-wrapper { margin:11px 0;}
    .file-input { display:none;}
    .file-input-label { display:inline-block; padding:7px 20px; background:#f0f0f7; border-radius:20px; cursor:pointer; }
    .file-input-label:hover { background:#e5e5ef; }
    .post-actions { display:flex; justify-content:space-between; align-items:center; margin-top:10px;}
    .post-btn { background:linear-gradient(135deg, #667eea, #764ba2); color:#fff; border:none; padding:9px 20px; border-radius:18px; font-size:15px; font-weight:500; transition:all 0.2s;}
    .post-btn:disabled { opacity:0.7; cursor:not-allowed; transform:scale(0.98);}
    .post-btn.publishing { animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .feed { display:flex; flex-direction:column; gap:16px;}
    .publication { background:#fff; border-radius:13px; padding:17px; box-shadow:0 2px 12px #0001; animation:slideIn 0.3s ease-out;}
    @keyframes slideIn { from{opacity:0; transform:translateY(-10px);} to{opacity:1; transform:translateY(0);}}
    .pub-header { display:flex; align-items:center; margin-bottom:10px;}
    .pub-avatar { width:36px; height:36px; border-radius:50%; background:linear-gradient(135deg,#667eea,#764ba2); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600; font-size:16px; margin-right:9px;}
    .pub-info { flex:1;}
    .pub-username { font-weight:bold; color:#333;}
    .pub-time { color:#666; font-size:13px;}
    .pub-text { margin-bottom:11px; white-space:pre-wrap; }
    .image-link { cursor:pointer; display:inline-block; max-width:100%; margin-bottom:12px;}
    .image-link img { max-width:100%; max-height:270px; border-radius:7px; box-shadow:0 1px 6px #0002; transition:transform 0.18s;}
    .image-link img:hover { transform:scale(1.04);}
    .image-optimizing { opacity: 0.7; position: relative; }
    .image-optimizing::after { content: 'üîÑ Optimisation...'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
    .modal-image-view { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.90); z-index:4000; justify-content:center; align-items:center;}
    .modal-image-view img { max-width:98vw; max-height:96vh; border-radius:12px; box-shadow:0 2px 32px #0008;}
    .close-modal-image { position:absolute; top:24px; right:40px; color:#fff; font-size:40px; cursor:pointer; z-index:4050;}
    .pub-actions { display:flex; gap:16px; margin-bottom:11px; padding:7px 0; border-top:1px solid #eee;}
    .action-btn { background:none; border:none; color:#666; cursor:pointer; font-size:15px; display:flex; align-items:center; gap:6px;}
    .action-btn:hover { color:#667eea;}
    .action-btn.liked { color:#e74c3c;}
    .comments-section { border-top:1px solid #eee; padding-top:10px;}
    .comment { background:#f7f7fb; padding:8px 14px; border-radius:8px; margin-bottom:7px;}
    .comment-header { display:flex; align-items:center; margin-bottom:4px;}
    .comment-avatar { width:26px; height:26px; border-radius:50%; background:linear-gradient(135deg, #667eea, #764ba2); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:bold; font-size:12px; margin-right:8px;}
    .comment-username { font-weight:bold; color:#333; font-size:13px;}
    .comment-time { color:#666; font-size:11px; margin-left:auto;}
    .comment-text { font-size:13px;}
    .comment-form { display:flex; gap:8px; margin-top:7px;}
    .comment-input { flex:1; padding:7px 12px; border:1px solid #ddd; border-radius:17px; font-size:13px; background:#fff;}
    .comment-input:focus { outline:none; border-color:#667eea;}
    .comment-btn { background:#667eea; color:#fff; border:none; padding:6px 13px; border-radius:16px; font-size:13px;}
    .comment-btn:hover { background:#5a67d8;}
    @media (max-width:680px) { .container{padding:4px;} .header h1{font-size:1.4em;} .registration-form{padding:18px 4px;} }
  </style>
</head>
<body>
<div style="text-align: right; margin-bottom: 14px;">
  <button id="showMyPostsBtn" class="post-btn" style="padding: 8px 22px; font-size:15px;">üóÇÔ∏è Mes publications</button>
</div>

<!-- Modal pour afficher la liste des publications de l'utilisateur -->
<div id="myPostsModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:2000; background:rgba(0,0,0,0.85); justify-content:center; align-items:center;">
  <div style="background:#fff; border-radius:18px; max-width:500px; width:95vw; max-height:85vh; overflow:auto; box-shadow:0 10px 40px #0005; padding:24px 18px 18px 18px; position:relative;">
    <span id="closeMyPostsModal" style="position:absolute; top:14px; right:28px; color:#764ba2; font-size:32px; cursor:pointer;">&times;</span>
    <h3 style="margin-top:0; margin-bottom:18px; color:#764ba2;">Mes publications</h3>
    <div id="myPostsList"></div>
  </div>
</div>

  <div class="video-background">
    <video autoplay muted loop>
      <source src="https://videos.pexels.com/video-files/5212456/5212456-hd_1920_1080_30fps.mp4" type="video/mp4">
      Votre navigateur ne supporte pas la vid√©o HTML5.
    </video>
  </div>
  <div class="video-overlay"></div>
  <div class="particles" id="particles"></div>

  <!-- Modal image agrandie -->
  <div class="modal-image-view" id="modalImageView">
    <span class="close-modal-image" onclick="closeImageModal()">&times;</span>
    <img id="modalImageBig" src="" alt="Image publication">
  </div>

  <!-- Formulaire d'inscription -->
  <div class="registration-overlay" id="registrationOverlay">
    <div class="registration-form">
      <h2>üéì Express Exchange</h2>
      <p>Rejoignez le r√©seau social √©tudiant</p>
      <form id="registrationForm">
        <div class="form-group">
          <label for="nom">Nom *</label>
          <input type="text" id="nom" name="nom" required>
        </div>
        <div class="form-group">
          <label for="prenom">Pr√©nom *</label>
          <input type="text" id="prenom" name="prenom" required>
        </div>
        <div class="form-group">
          <label for="contact">Contact (Email ou T√©l√©phone) *</label>
          <input type="text" id="contact" name="contact" required>
        </div>
        <button type="submit" class="submit-btn">Rejoindre Express Exchange</button>
      </form>
    </div>
  </div>

  <!-- Interface principale -->
  <div class="main-app" id="mainApp">
    <div class="container">
      <div class="header">
        <h1>üì± Express Exchange</h1>
        <div class="user-info" id="userInfo">
          <span id="welcomeMessage"></span>
          <span class="status-indicator" id="statusIndicator">üîÑ Connexion...</span>
        </div>
      </div>
      <div class="post-form" style="position:relative;">
        <textarea class="post-textarea" id="postText" placeholder="Que voulez-vous partager ?"></textarea>
        <div class="file-input-wrapper">
          <input type="file" id="fileInput" class="file-input" accept="image/*">
          <label for="fileInput" class="file-input-label">
            üì∑ Ajouter une photo
          </label>
          <span id="fileName"></span>
        </div>
        <div class="post-actions">
          <div id="mediaPreview"></div>
          <button class="post-btn" id="publishBtn">Publier</button>
        </div>
      </div>
      <div class="feed" id="feed"></div>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
<script>
  // --- CONFIG FIREBASE ---
  const firebaseConfig = {
    apiKey: "AIzaSyCPGgtXoDUycykLaTSee0S0yY0tkeJpqKI",
    authDomain: "data-com-a94a8.firebaseapp.com",
    databaseURL: "https://data-com-a94a8-default-rtdb.firebaseio.com",
    projectId: "data-com-a94a8",
    storageBucket: "data-com-a94a8.appspot.com",
    messagingSenderId: "276904640935",
    appId: "1:276904640935:web:9cd805aeba6c34c767f682",
    measurementId: "G-FYQCWY5G4S"
  };
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  let userData = null;
  let posts = [];
  let postsListener = null;
  let isConnected = false;

  // Nettoyage de tous les undefined dans les objets envoy√©s √† Firebase
  function removeUndefinedDeep(obj) {
    if (Array.isArray(obj)) {
      return obj.map(removeUndefinedDeep);
    } else if (obj && typeof obj === 'object') {
      const cleaned = {};
      for (const key in obj) {
        if (obj[key] !== undefined) {
          cleaned[key] = removeUndefinedDeep(obj[key]);
        }
      }
      return cleaned;
    }
    return obj;
  }

  function updateConnectionStatus() {
    const statusIndicator = document.getElementById('statusIndicator');
    if (statusIndicator) {
      statusIndicator.textContent = isConnected ? 'üü¢ Connect√©' : 'üî¥ Hors ligne';
      statusIndicator.className = isConnected ? 'status-indicator status-connected' : 'status-indicator status-disconnected';
    }
  }

  database.ref(".info/connected").on("value", (snap) => {
    isConnected = snap.val() === true;
    updateConnectionStatus();
  });

  function checkUserRegistration() {
    const stored = localStorage.getItem('expressExchangeUser');
    if (stored) {
      userData = JSON.parse(stored);
      showMainApp();
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    createParticles();
    checkUserRegistration();
    setInterval(() => {
      if (document.getElementById('mainApp').style.display !== 'none') renderPosts();
    }, 60000);
  });

  // ========= COMPRESSION ASYNCHRONE EN ARRI√àRE-PLAN =========
  function asyncImageCompress(file) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          // Utilisation de setTimeout pour rendre le processus asynchrone
          setTimeout(() => {
            let { width, height } = img;
            
            // Compression aggressive pour la rapidit√©
            const maxSize = 600;
            if (width > maxSize || height > maxSize) {
              const ratio = Math.min(maxSize / width, maxSize / height);
              width = Math.round(width * ratio);
              height = Math.round(height * ratio);
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            // Optimisation pour la rapidit√©
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(img, 0, 0, width, height);
            
            const compressedUrl = canvas.toDataURL('image/jpeg', 0.8);
            resolve(compressedUrl);
          }, 0); // Permet √† l'UI de se mettre √† jour avant de commencer la compression
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });
  }

  document.getElementById('registrationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const nom = document.getElementById('nom').value.trim();
    const prenom = document.getElementById('prenom').value.trim();
    const contact = document.getElementById('contact').value.trim();
    if (nom && prenom && contact) {
      userData = {
        id: Date.now().toString(),
        nom: nom,
        prenom: prenom,
        contact: contact,
        fullName: `${prenom} ${nom}`,
        avatar: `${prenom[0]}${nom[0]}`.toUpperCase(),
        registeredAt: new Date().toISOString()
      };
      localStorage.setItem('expressExchangeUser', JSON.stringify(userData));
      if (isConnected) database.ref('users/' + userData.id).set(userData);
      showMainApp();
    }
  });

  function showMainApp() {
    document.getElementById('registrationOverlay').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('welcomeMessage').textContent = `Bienvenue ${userData.fullName} üëã`;
    updateConnectionStatus();
    loadPosts();
  }

  function loadPosts() {
    if (postsListener) postsListener.off();
    postsListener = database.ref('posts').orderByChild('timestamp');
    postsListener.on('value', (snapshot) => {
      posts = [];
      snapshot.forEach((childSnapshot) => {
        const post = childSnapshot.val();
        posts.unshift(post);
      });
      renderPosts();
    });
  }

  // ========= PUBLICATION ULTRA-RAPIDE =========
  document.getElementById('publishBtn').addEventListener('click', function() {
    const text = document.getElementById('postText').value.trim();
    const fileInput = document.getElementById('fileInput');
    const publishBtn = document.getElementById('publishBtn');
    
    if (!text && !fileInput.files[0]) {
      alert('Veuillez ajouter du texte ou une image');
      return;
    }
    
    // Validation rapide du type de fichier (sans lecture)
    const file = fileInput.files[0];
    if (file && !file.type.startsWith('image/')) {
      alert("Seules les images sont autoris√©es.");
      return;
    }

    // ‚ö° FEEDBACK INSTANTAN√â ‚ö°
    publishBtn.disabled = true;
    publishBtn.classList.add('publishing');
    publishBtn.textContent = 'Publication...';

    const postId = Date.now().toString();
    
    if (file) {
      // ‚ú® PUBLICATION IMM√âDIATE avec placeholder ‚ú®
      const post = {
        id: postId,
        author: userData.fullName,
        authorId: userData.id,
        avatar: userData.avatar,
        text: text,
        imageUrl: URL.createObjectURL(file), // URL temporaire instantan√©e
        imageOptimizing: true, // Flag pour indiquer l'optimisation
        timestamp: new Date().toISOString()
      };

      // Ajout INSTANTAN√â au feed (0ms de latence)
      posts.unshift(post);
      renderPosts();
      clearPostForm();
      resetPublishButton();

      // üîÑ COMPRESSION et UPLOAD EN PARALL√àLE (non-bloquant)
      asyncImageCompress(file).then(compressedUrl => {
        // Mise √† jour avec l'image optimis√©e
        const localPost = posts.find(p => p.id === postId);
        if (localPost) {
          localPost.imageUrl = compressedUrl;
          localPost.imageOptimizing = false;
          renderPosts(); // Re-render avec l'image optimis√©e
        }

        // Sauvegarde Firebase avec l'image optimis√©e
        const finalPost = { ...post, imageUrl: compressedUrl };
        delete finalPost.imageOptimizing;
        database.ref('posts/' + postId).set(removeUndefinedDeep(finalPost));
      });
    } else {
      // ‚ö° PUBLICATION TEXTE - INSTANTAN√âE ‚ö°
      const post = {
        id: postId,
        author: userData.fullName,
        authorId: userData.id,
        avatar: userData.avatar,
        text: text,
        imageUrl: null,
        timestamp: new Date().toISOString()
      };

      // Ajout instantan√©
      posts.unshift(post);
      renderPosts();
      clearPostForm();
      resetPublishButton();

      // Sauvegarde Firebase (non-bloquant)
      database.ref('posts/' + postId).set(removeUndefinedDeep(post));
    }
  });

  function resetPublishButton() {
    const publishBtn = document.getElementById('publishBtn');
    publishBtn.disabled = false;
    publishBtn.classList.remove('publishing');
    publishBtn.textContent = 'Publier';
  }

  document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const fileName = document.getElementById('fileName');
    const preview = document.getElementById('mediaPreview');
    
    if (file) {
      fileName.textContent = file.name;
      // Pr√©visualisation instantan√©e avec URL temporaire
      const tempUrl = URL.createObjectURL(file);
      preview.innerHTML = `<img src="${tempUrl}" style="max-width: 100px; max-height: 100px; border-radius: 5px;">`;
    } else {
      fileName.textContent = '';
      preview.innerHTML = '';
    }
  });

  function clearPostForm() {
    document.getElementById('postText').value = '';
    document.getElementById('fileInput').value = '';
    document.getElementById('fileName').textContent = '';
    document.getElementById('mediaPreview').innerHTML = '';
  }

  // --- Modal image ---
  window.openImageModal = function(imgUrl) {
    const modal = document.getElementById('modalImageView');
    const modalImg = document.getElementById('modalImageBig');
    modal.style.display = 'flex';
    modalImg.src = imgUrl;
  };

  window.closeImageModal = function() {
    document.getElementById('modalImageView').style.display = 'none';
  };

  document.getElementById('modalImageView').addEventListener('click', function(e){
    if(e.target === this){ closeImageModal(); }
  });

  document.addEventListener('keydown', function(e){
    if(e.key === 'Escape'){ closeImageModal(); }
  });

  // --- Likes et commentaires avec mises √† jour instantan√©es ---
  function listenLikesAndComments(postId) {
    database.ref('likes/' + postId).on('value', snap => {
      const likes = snap.val() || {};
      const cleanedLikes = removeUndefinedDeep(likes);
      const post = posts.find(p => p.id === postId);
      if (post) {
        post.likes = cleanedLikes;
        updateLikeButton(postId, cleanedLikes);
      }
    });

    database.ref('comments/' + postId).on('value', snap => {
      const comments = snap.val() || {};
      const cleanedComments = removeUndefinedDeep(comments);
      const post = posts.find(p => p.id === postId);
      if (post) {
        post.comments = cleanedComments;
        updateCommentsSection(postId, cleanedComments);
      }
    });
  }

  function updateLikeButton(postId, likes) {
    const btn = document.getElementById('like-btn-' + postId);
    if (btn) {
      const likesCount = Object.keys(likes).length;
      const isLiked = likes[userData.id];
      btn.innerHTML = `${isLiked ? '‚ù§Ô∏è' : 'ü§ç'} ${likesCount}`;
      btn.className = `action-btn ${isLiked ? 'liked' : ''}`;
    }
  }

  function updateCommentsSection(postId, comments) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (commentsSection) {
      const commentsList = Object.values(comments).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      const commentsHTML = commentsList.map(comment => `
        <div class="comment">
          <div class="comment-header">
            <div class="comment-avatar">${comment.avatar}</div>
            <div class="comment-username">${comment.author}</div>
            <div class="comment-time">${getTimeAgo(comment.timestamp)}</div>
          </div>
          <div class="comment-text">${comment.text}</div>
        </div>
      `).join('');
      
      const commentForm = commentsSection.querySelector('.comment-form');
      commentsSection.innerHTML = commentsHTML + commentForm.outerHTML;
      
      const commentBtn = document.querySelector(`button[onclick="toggleComments('${postId}')"]`);
      if (commentBtn) {
        commentBtn.innerHTML = `üí¨ ${Object.keys(comments).length}`;
      }
    }
  }

  function renderPosts() {
    const feed = document.getElementById('feed');
    feed.innerHTML = '';
    posts.forEach(post => {
      if (!post._listeners) {
        listenLikesAndComments(post.id);
        post._listeners = true;
      }
      const likesCount = post.likes ? Object.keys(post.likes).length : 0;
      const commentsCount = post.comments ? Object.keys(post.comments).length : 0;
      const isLiked = post.likes && post.likes[userData.id];
      const timeAgo = getTimeAgo(post.timestamp);
      
      let imageHTML = '';
      if (post.imageUrl) {
        const optimizingClass = post.imageOptimizing ? 'image-optimizing' : '';
        imageHTML = `
          <div class="${optimizingClass}">
            <a class="image-link" onclick="openImageModal('${post.imageUrl}')">
              <img src="${post.imageUrl}" alt="Image publication" loading="lazy">
            </a>
          </div>
        `;
      }
      
      let commentsHTML = '';
      if (post.comments) {
        const commentsList = Object.values(post.comments).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        commentsHTML = commentsList.map(comment => `
          <div class="comment">
            <div class="comment-header">
              <div class="comment-avatar">${comment.avatar}</div>
              <div class="comment-username">${comment.author}</div>
              <div class="comment-time">${getTimeAgo(comment.timestamp)}</div>
            </div>
            <div class="comment-text">${comment.text}</div>
          </div>
        `).join('');
      }
      
      const postHtml = `
        <div class="publication">
          <div class="pub-header">
            <div class="pub-avatar">${post.avatar}</div>
            <div class="pub-info">
              <div class="pub-username">${post.author}</div>
              <div class="pub-time">${timeAgo}</div>
            </div>
          </div>
          <div class="pub-text">${post.text}</div>
          ${imageHTML}
          <div class="pub-actions">
            <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${post.id}')" id="like-btn-${post.id}">
              ${isLiked ? '‚ù§Ô∏è' : 'ü§ç'} ${likesCount}
            </button>
            <button class="action-btn" onclick="toggleComments('${post.id}')">
              üí¨ ${commentsCount}
            </button>
          </div>
          <div class="comments-section" id="comments-${post.id}" style="display: none;">
            ${commentsHTML}
            <div class="comment-form">
              <input type="text" class="comment-input" placeholder="√âcrivez un commentaire..." id="comment-input-${post.id}">
              <button class="comment-btn" onclick="submitComment('${post.id}')">Envoyer</button>
            </div>
          </div>
        </div>
      `;
      feed.innerHTML += postHtml;
    });
  }

  // ========= INTERACTIONS INSTANTAN√âES =========
  window.toggleLike = function(postId) {
    const btn = document.getElementById('like-btn-' + postId);
    const post = posts.find(p => p.id === postId);
    
    if (!post) return;
    
    // Mise √† jour instantan√©e de l'UI
    if (!post.likes) post.likes = {};
    const isCurrentlyLiked = post.likes[userData.id];
    
    if (isCurrentlyLiked) {
      delete post.likes[userData.id];
    } else {
      post.likes[userData.id] = {
        userId: userData.id,
        username: userData.fullName,
        timestamp: new Date().toISOString()
      };
    }
    
    // Mise √† jour imm√©diate du bouton
    updateLikeButton(postId, post.likes);
    
    // Synchronisation Firebase en arri√®re-plan
    const likeRef = database.ref('likes/' + postId + '/' + userData.id);
    if (isCurrentlyLiked) {
      likeRef.remove();
    } else {
      likeRef.set(removeUndefinedDeep({
        userId: userData.id,
        username: userData.fullName,
        timestamp: new Date().toISOString()
      }));
    }
  };

  window.toggleComments = function(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
  };

  window.submitComment = function(postId) {
    const input = document.getElementById(`comment-input-${postId}`);
    const commentText = input.value.trim();
    if (!commentText) return;
    
    const commentId = Date.now().toString();
    const comment = {
      id: commentId,
      author: userData.fullName,
      authorId: userData.id,
      avatar: userData.avatar,
      text: commentText,
      timestamp: new Date().toISOString()
    };
    
    // Ajout instantan√© au post local
    const post = posts.find(p => p.id === postId);
    if (post) {
      if (!post.comments) post.comments = {};
      post.comments[commentId] = comment;
      updateCommentsSection(postId, post.comments);
    }
    
    // Vider le champ imm√©diatement
    input.value = '';
    
    // Synchronisation Firebase en arri√®re-plan
    database.ref('comments/' + postId + '/' + commentId).set(removeUndefinedDeep(comment));
  };

  document.addEventListener('keydown', function(e) {
    if (e.target.classList.contains('comment-input') && e.key === 'Enter') {
      const postId = e.target.id.replace('comment-input-', '');
      window.submitComment(postId);
    }
  });

  function getTimeAgo(timestamp) {
    const now = new Date();
    const time = new Date(timestamp);
    const diffInSeconds = Math.floor((now - time) / 1000);
    if (diffInSeconds < 60) return '√Ä l\'instant';
    if (diffInSeconds < 3600) {
      const minutes = Math.floor(diffInSeconds / 60);
      return `Il y a ${minutes} minute${minutes > 1 ? 's' : ''}`;
    } else if (diffInSeconds < 86400) {
      const hours = Math.floor(diffInSeconds / 3600);
      return `Il y a ${hours} heure${hours > 1 ? 's' : ''}`;
    } else {
      const days = Math.floor(diffInSeconds / 86400);
      return `Il y a ${days} jour${days > 1 ? 's' : ''}`;
    }
  }

  function createParticles() {
    const particles = document.getElementById('particles');
    if (!particles) return;
    for (let i = 0; i < 20; i++) {
      const particle = document.createElement('div');
      particle.className = 'particle';
      particle.style.left = Math.random() * 100 + '%';
      particle.style.animationDelay = Math.random() * 6 + 's';
      particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
      particles.appendChild(particle);
    }
  }

  window.addEventListener('resize', function() {
    const particles = document.getElementById('particles');
    if (particles) {
      particles.innerHTML = '';
      createParticles();
    }
  });

  // ========= GESTION DES PUBLICATIONS PERSONNELLES =========
  document.getElementById('showMyPostsBtn').addEventListener('click', function() {
    showMyPostsModal();
  });

  document.getElementById('closeMyPostsModal').onclick = function() {
    document.getElementById('myPostsModal').style.display = 'none';
  };

  document.getElementById('myPostsModal').onclick = function(e) {
    if (e.target === this) this.style.display = 'none';
  };

  function showMyPostsModal() {
    const listEl = document.getElementById('myPostsList');
    const myPosts = posts.filter(p => p.authorId === userData.id);
    if (myPosts.length === 0) {
      listEl.innerHTML = `<div style="color:#555; padding:18px; text-align:center;">Aucune publication trouv√©e.</div>`;
    } else {
      listEl.innerHTML = myPosts.map(post => {
        const timeAgo = getTimeAgo(post.timestamp);
        let img = post.imageUrl ? `<img src="${post.imageUrl}" alt="" style="max-width:80px; max-height:80px; border-radius:7px; margin-bottom:8px; display:block;">` : "";
        return `
          <div style="border-bottom:1px solid #eee; padding:10px 0 11px 0; display:flex; gap:14px; align-items:center;">
            <div style="flex:0 0 80px;">
              ${img}
            </div>
            <div style="flex:1;">
              <div style="font-weight:500; color:#222;">${post.text ? post.text : "(aucun texte)"}</div>
              <div style="font-size:13px; color:#666; margin-top:3px;">${timeAgo}</div>
            </div>
            <button onclick="deleteMyPost('${post.id}')" style="margin-left:10px; background:linear-gradient(135deg, #e85c6b, #c44569); color:#fff; border:none; border-radius:8px; padding:7px 12px; font-size:13px; cursor:pointer;">
              Supprimer
            </button>
          </div>
        `;
      }).join('');
    }
    document.getElementById('myPostsModal').style.display = 'flex';
  }

  window.deleteMyPost = function(postId) {
    if (!confirm("Voulez-vous vraiment supprimer cette publication ? Cette action est irr√©versible.")) return;
    
    // Suppression instantan√©e du feed local
    posts = posts.filter(post => post.id !== postId);
    renderPosts();
    showMyPostsModal(); // Refresh la liste
    
    // Suppression Firebase en arri√®re-plan
    const updates = {};
    updates['/posts/' + postId] = null;
    updates['/likes/' + postId] = null;
    updates['/comments/' + postId] = null;
    firebase.database().ref().update(updates)
      .catch(() => {
        alert("Erreur lors de la suppression. La publication pourrait r√©appara√Ætre.");
        // En cas d'erreur, recharger depuis Firebase
        loadPosts();
      });
  };

  // ========= OPTIMISATIONS PERFORMANCES =========
  
  // Debounce pour √©viter trop de rendus
  let renderTimeout;
  function debouncedRender() {
    if (renderTimeout) clearTimeout(renderTimeout);
    renderTimeout = setTimeout(renderPosts, 100);
  }
  
  // Pr√©chargement des images pour une navigation fluide
  function preloadImages() {
    posts.forEach(post => {
      if (post.imageUrl && !post.imageOptimizing) {
        const img = new Image();
        img.src = post.imageUrl;
      }
    });
  }
  
  // Appel du pr√©chargement apr√®s le rendu
  setTimeout(preloadImages, 1000);
  
  // Optimisation m√©moire - nettoyage des listeners inutiles
  window.addEventListener('beforeunload', function() {
    if (postsListener) postsListener.off();
    // Nettoyage des URLs temporaires
    posts.forEach(post => {
      if (post.imageUrl && post.imageUrl.startsWith('blob:')) {
        URL.revokeObjectURL(post.imageUrl);
      }
    });
  });

</script>
</body>
</html>
