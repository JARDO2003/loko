<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Démo WebAuthn (biométrie / webcam)</title>
    <style>
        body { background: #222; color: #fff; font-family: sans-serif; padding: 40px;}
        button { padding: 12px 28px; font-size: 18px; border-radius: 8px; background: #0095f6; color: #fff; border: none; margin-right: 10px;}
        button:hover { background: #007acc; cursor: pointer; }
        #status { margin-top: 24px; font-size: 20px;}
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
    </style>
</head>
<body>
    <h2>Test d'authentification biométrique (WebAuthn)</h2>
    <button id="registerBtn">Enregistrer une clé biométrique</button>
    <button id="loginBtn">Connexion biométrique</button>
    <div id="status"></div>
    <script>
        // Helper pour affichage
        function setStatus(msg, type = 'info') { 
            const statusEl = document.getElementById('status');
            statusEl.textContent = msg;
            statusEl.className = type;
        }

        // Fonction pour convertir string en Uint8Array de manière plus robuste
        function stringToUint8Array(str) {
            return new Uint8Array(str.split('').map(c => c.charCodeAt(0)));
        }

        // Fonction pour convertir ArrayBuffer en string base64url
        function arrayBufferToBase64url(buffer) {
            const bytes = new Uint8Array(buffer);
            let str = '';
            for (let i = 0; i < bytes.length; i++) {
                str += String.fromCharCode(bytes[i]);
            }
            return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        // 1. Enregistrement du credential (clé biométrique)
        document.getElementById('registerBtn').onclick = async () => {
            if (!window.PublicKeyCredential) {
                setStatus("WebAuthn n'est pas supporté sur ce navigateur.", 'error');
                return;
            }
            
            setStatus("Vérification de la disponibilité...", 'info');
            
            // Vérifier si WebAuthn est disponible
            const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
            if (!available) {
                setStatus("Aucun authentificateur biométrique disponible sur cet appareil.", 'error');
                return;
            }
            
            setStatus("Enregistrement en cours...", 'info');
            
            try {
                // Générer un challenge aléatoire (en production, vient du serveur)
                const challenge = crypto.getRandomValues(new Uint8Array(32));
                const userId = crypto.getRandomValues(new Uint8Array(16));
                
                const publicKey = {
                    challenge,
                    rp: { 
                        name: "Express Exchange Demo",
                        id: window.location.hostname
                    },
                    user: { 
                        id: userId, 
                        name: "demo@example.com", 
                        displayName: "Utilisateur Demo" 
                    },
                    // CORRECTION : Ajouter ES256 (-7) et RS256 (-257) comme recommandé
                    pubKeyCredParams: [
                        { type: "public-key", alg: -7 },   // ES256 (ECDSA w/ SHA-256)
                        { type: "public-key", alg: -257 }  // RS256 (RSASSA-PKCS1-v1_5 w/ SHA-256)
                    ],
                    authenticatorSelection: { 
                        authenticatorAttachment: "platform", 
                        userVerification: "required",
                        residentKey: "preferred"
                    },
                    timeout: 60000,
                    attestation: "none" // Changé de "direct" à "none" pour éviter les problèmes de confidentialité
                };
                
                const credential = await navigator.credentials.create({ publicKey });
                
                if (credential) {
                    // Sauvegarder l'ID du credential
                    const credentialId = arrayBufferToBase64url(credential.rawId);
                    localStorage.setItem('webauthn_credential_id', credentialId);
                    
                    setStatus(`✅ Clé biométrique enregistrée avec succès! ID: ${credentialId.substring(0, 20)}...`, 'success');
                } else {
                    setStatus("Échec de l'enregistrement.", 'error');
                }
            } catch(e) {
                console.error('Erreur WebAuthn:', e);
                let errorMsg = "Erreur WebAuthn: ";
                
                switch(e.name) {
                    case 'NotAllowedError':
                        errorMsg += "Opération refusée ou annulée par l'utilisateur";
                        break;
                    case 'InvalidStateError':
                        errorMsg += "Une clé est déjà enregistrée pour cet utilisateur";
                        break;
                    case 'NotSupportedError':
                        errorMsg += "Fonctionnalité non supportée";
                        break;
                    default:
                        errorMsg += e.message || "Erreur inconnue";
                }
                
                setStatus(errorMsg, 'error');
            }
        };

        // 2. Connexion biométrique (FaceID/webcam/empreinte)
        document.getElementById('loginBtn').onclick = async () => {
            const savedCredentialId = localStorage.getItem('webauthn_credential_id');
            
            if (!savedCredentialId) {
                setStatus("Aucune clé biométrique enregistrée. Enregistrez d'abord une clé!", 'error');
                return;
            }
            
            setStatus("Authentification en cours...", 'info');
            
            try {
                // Challenge aléatoire (en production, vient du serveur)
                const challenge = crypto.getRandomValues(new Uint8Array(32));
                
                // Convertir l'ID base64url en ArrayBuffer
                function base64urlToArrayBuffer(base64url) {
                    const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
                    const padded = base64.padEnd(base64.length + (4 - base64.length % 4) % 4, '=');
                    const binary = atob(padded);
                    const bytes = new Uint8Array(binary.length);
                    for (let i = 0; i < binary.length; i++) {
                        bytes[i] = binary.charCodeAt(i);
                    }
                    return bytes.buffer;
                }
                
                const publicKey = {
                    challenge,
                    allowCredentials: [{
                        id: base64urlToArrayBuffer(savedCredentialId),
                        type: "public-key",
                        transports: ["internal", "platform"]
                    }],
                    timeout: 60000,
                    userVerification: "required"
                };
                
                const assertion = await navigator.credentials.get({ publicKey });
                
                if (assertion) {
                    const assertionId = arrayBufferToBase64url(assertion.rawId);
                    setStatus(`✅ Authentification réussie! ID: ${assertionId.substring(0, 20)}...`, 'success');
                } else {
                    setStatus("Échec de l'authentification.", 'error');
                }
            } catch(e) {
                console.error('Erreur WebAuthn:', e);
                let errorMsg = "Erreur d'authentification: ";
                
                switch(e.name) {
                    case 'NotAllowedError':
                        errorMsg += "Authentification refusée ou annulée";
                        break;
                    case 'InvalidStateError':
                        errorMsg += "Credential invalide";
                        break;
                    case 'UnknownError':
                        errorMsg += "Credential non trouvé";
                        break;
                    default:
                        errorMsg += e.message || "Erreur inconnue";
                }
                
                setStatus(errorMsg, 'error');
            }
        };

        // Vérifier la compatibilité au chargement
        window.addEventListener('load', async () => {
            if (!window.PublicKeyCredential) {
                setStatus("❌ WebAuthn n'est pas supporté sur ce navigateur.", 'error');
                return;
            }
            
            const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
            if (available) {
                setStatus("✅ Authentificateur biométrique disponible. Vous pouvez enregistrer une clé.", 'success');
            } else {
                setStatus("⚠️ Aucun authentificateur biométrique détecté sur cet appareil.", 'error');
            }
        });
    </script>
</body>
</html>
